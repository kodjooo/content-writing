# План реализации

## Этап 1. Подготовка инфраструктуры
- Уточнить структуру `.env`, собрать обязательные переменные (ключ OpenAI, путь к `service_account.json`, идентификаторы таблицы и папки Drive, параметры обработки) и добавить пример в репозиторий (`.env.example`).
- Настроить управление зависимостями (poetry/requirements.txt), прописать библиотеки `openai`, `gspread`, `google-auth`, `google-api-python-client`, `tenacity`, `python-dotenv`.
- Инициализировать модуль логирования (стандартный `logging`) и базовую структуру проекта (пакеты для сервисов, конфигурации, оркестратора).

## Этап 2. Клиенты Google и управление таблицей
- Реализовать загрузку сервисного аккаунта и авторизацию через `google.oauth2.service_account.Credentials`.
- Создать обёртку над Google Sheets (через `gspread`): выбор вкладки по конфигурации, поиск первой строки со статусом `Prepared` и пустым `Lock`, установка блокировки с тайм-аутом.
- Реализовать операции чтения/записи с минимальным числом запросов (батч-обновления), обновление столбцов `Content`, `Image URL`, `Status`, `Iteration`, `Moderator Note`, `Lock`.

## Этап 3. Клиент Google Drive
- Настроить клиент через `google-api-python-client` (`drive_v3`), parametrизовать целевую папку из `.env`.
- Реализовать загрузку изображений из временного файла, установку доступа `anyoneWithLink`, получение `webViewLink`.
- Добавить утилиту для генерации имени файла по шаблону «Title + дата», очистку временной директории после отправки.

## Этап 4. Интеграция с OpenAI Assistants
- Написать универсальную функцию `run_assistant(assistant_id, message)` с созданием треда, запуском `run`, ожиданием завершения и возвратом текста.
- Добавить конфигурацию ассистентов: по вкладке таблицы выбирается писатель и модератор, отдельный глобальный ассистент для художественного брифа.
- Реализовать обработку ответов модератора (нормализация, проверка вариантов «ок», сохранение примечаний в таблицу).

## Этап 5. Генерация и сохранение изображений
- Реализовать обёртку над `client.images.generate` для модели `gpt-image-1` с параметрами размера и ретраями.
- Добавить конвертацию ответа в бинарные данные, сохранение в `./tmp`, передачу в клиент Google Drive, возврат публичной ссылки.

## Этап 6. Основной цикл обработки строки
- Реализовать функцию `process_one_row`: получение строки, установка `Lock`, чтение `Title`, запуск сценария писатель → модератор с ограничением `max_revisions` и формированием повторного запроса `Текст/Комментарий`.
- Обрабатывать сценарий, когда лимит исчерпан: фиксировать статус `Written (not moderated)` и последний комментарий.
- После успешной модерации запускать ассистента брифа, генерировать изображение, записывать `Content`, `Image URL`, финальный `Status`, снимать `Lock`.
- Добавить валидацию обязательных столбцов и обработку случая отсутствия строк со статусом `Prepared`.

## Этап 7. Надёжность и обработка ошибок
- Обернуть сетевые вызовы в ретраи (`tenacity`) с экспоненциальной задержкой и логированием.
- Реализовать единый перехват исключений: при ошибках записывать `Moderator Note`/`Error`, снимать `Lock`.
- Добавить возможность ограниченного запуска по параметру `per_run_rows` (обработка нескольких строк подряд).

## Этап 8. Тестирование и отладка
- Подготовить мок-объекты для OpenAI и Google API, написать unit-тесты ключевых функций (нормализация «ок», построение запроса писателю, логика `Lock`).
- Настроить интеграционные тесты с локальными заглушками (например, через `responses`/`httpretty`).
- Проверить сценарии из требований: отсутствие Prepared строк, итерации модерации, неудача генерации изображения.

## Этап 9. Автоматизация запуска
- Собрать Docker-окружение: образ с Python, зависимостями и входной точкой `python -m app`.
- Добавить сервис в `docker-compose.yml`, пробросить `.env`, каталог с временными файлами, настроить расписание (cron / внешняя оркестрация).
- Обновить README ключевой информацией по запуску (только необходимый минимум).
