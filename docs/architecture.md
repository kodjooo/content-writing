# Архитектура контент-пайплайна

## Общая структура
Приложение построено вокруг модульного пакета `app`, где каждый подмодуль отвечает за отдельный аспект пайплайна. Основная точка входа `app/main.py` загружает конфигурацию, настраивает логирование и делегирует работу оркестратору `app/orchestrator/runner.py`.

## Конфигурация и логирование
- `app/config/settings.py` формирует объект `Settings`, загружая переменные окружения, проверяя наличие обязательных значений и создавая директории для временных файлов. Для каждой вкладки в Google Sheets описывается пара ассистентов (писатель и модератор), которые дополнительно валидируются перед использованием.
  Дополнительно поддерживается флаг `IMAGE_GENERATION_ENABLED`, позволяющий отключить генерацию изображений без изменения логики обработки строк.
- `app/logging.py` предоставляет вспомогательные функции `configure_logging` и `get_logger`, обеспечивая консистентное форматирование логов во всех компонентах.

## Работа с внешними сервисами
- `app/services/google_auth.py` создаёт `Credentials` сервисного аккаунта Google с доступом к Google Sheets.
- `app/services/google_sheets.py` инкапсулирует доступ к Google Sheets: кеширует метаданные листов, находит первую строку со статусом `Prepared`, выставляет и снимает блокировки, а также выполняет точечные батч-обновления столбцов.
- `app/services/image_hosting.py` реализует клиент FreeImage.host: формирует имя файла, отправляет запрос `multipart/form-data`, валидирует ответ и возвращает публичную ссылку на изображение.
- `app/services/image_generation.py` содержит `ImageGenerator`, который обращается к модели генерации изображений (по умолчанию `gpt-image-1`, настраивается переменной `IMAGE_MODEL`), применяет ретраи и возвращает бинарные данные изображения, и `ImagePipeline`, сочетающий генератор с клиентом загрузки. Качество и размер изображений задаются параметрами `IMAGE_QUALITY` и `IMAGE_SIZE`; допустимые значения зависят от выбранной модели (для `gpt-image-1` — `low/medium/high/auto` и `1024x1024/1024x1536/1536x1024/auto`, для `dall-e` — `standard|hd` и `1024x1024`).
- `app/services/openai_assistants.py` отвечает за обращение к OpenAI Assistants: создаёт треды, отслеживает завершение прогонов, извлекает текстовые ответы и содержит утилиты для обработки решений модератора и формирования запросов на переработку текста.
- `app/utils/retry.py` предоставляет фабрику `create_retrying`, которая используется сервисами для унифицированной настройки экспоненциальных повторов.

Все перечисленные сервисы экспортируются через `app/services/__init__.py`, что облегчает их использование в других частях приложения.

## Оркестратор
`app/orchestrator/runner.py` управляет циклом обработки: инициализирует клиентов (Assistants, Google Sheets, загрузку изображений) и обрабатывает до `per_run_rows` строк, распределяя их по вкладкам. Каждая строка передаётся в `app/orchestrator/processor.py`, который организует полный цикл "писатель → модератор", контролирует лимит итераций, обращается к художественному брифу, генерирует изображение (если это разрешено настройкой) и обновляет все связанные столбцы таблицы. Ошибки фиксируются в таблице (`Status=Error`, `Moderator Note`), после чего блокировка `Lock` снимается вне зависимости от результата.

## Тестирование
- Для автоматических проверок используется `pytest`, тесты сгруппированы по уровням: модульные (`tests/unit`) и интеграционные (`tests/integration`).
- Модульные сценарии покрывают детерминированные функции (`normalize_moderator_reply`, `is_moderator_approved`, построение промтов и проверку поведения `Lock`). Для контроля времени блокировки применяется фиксированный `datetime` через подмену в модуле.
- Интеграционные тесты эмулируют работу `process_row` и `runner.run_once` с локальными заглушками вместо реальных клиентов OpenAI и Google, что позволяет проверять ключевые сценарии требований (отсутствие Prepared строк, лимит модерации, сбой генерации изображения) без сетевых вызовов.
- Заглушки клиентов фиксируют входные сообщения и обновляемые значения, что делает возможным детально проверять побочные эффекты (обновление столбцов, установка Lock, обработку статусов).

## Docker-окружение
Сборка и запуск приложения происходит через Docker (образ `python:3.12-slim`). Зависимости устанавливаются во время билда из `requirements.txt`, после чего в контейнер копируется пакет `app`. Запуск выполняется командой `python -m app.main`.

Файл `docker-compose.yml` описывает сервис `app`, который:
- использует образ, собранный из текущего репозитория;
- считывает переменные из `.env` и принимает оверрайды (например, `IMAGE_GENERATION_ENABLED`);
- монтирует директорию `tmp/` для временных файлов и `secrets/` для `google-credentials.json`;
- может быть запущен в фоне планировщиком (`docker compose run --rm app`).
