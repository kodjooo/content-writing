# Архитектура контент-пайплайна

## Общая структура
Приложение построено вокруг модульного пакета `app`, где каждый подмодуль отвечает за отдельный аспект пайплайна. Основная точка входа `app/main.py` загружает конфигурацию, настраивает логирование и делегирует работу оркестратору `app/orchestrator/runner.py`.

## Конфигурация и логирование
- `app/config/settings.py` формирует объект `Settings`, загружая переменные окружения, проверяя наличие обязательных значений и создавая директории для временных файлов. Для каждой вкладки в Google Sheets описывается пара ассистентов (писатель и модератор), которые дополнительно валидируются перед использованием.
  Дополнительно поддерживается флаг `IMAGE_GENERATION_ENABLED`, позволяющий отключить генерацию изображений без изменения логики обработки строк.
- `app/logging.py` предоставляет вспомогательные функции `configure_logging` и `get_logger`, обеспечивая консистентное форматирование логов во всех компонентах.

## Работа с внешними сервисами
- `app/services/google_auth.py` создаёт `Credentials` сервисного аккаунта Google с необходимыми правами (Sheets и Drive).
- `app/services/google_sheets.py` инкапсулирует доступ к Google Sheets: кеширует метаданные листов, находит первую строку со статусом `Prepared`, выставляет и снимает блокировки, а также выполняет точечные батч-обновления столбцов.
- `app/services/google_drive.py` реализует клиент для загрузки изображений: генерирует уникальные имена файлов, сохраняет временные файлы, отправляет их в целевую папку Google Drive и выставляет публичные права доступа.
- `app/services/image_generation.py` содержит `ImageGenerator`, который обращается к модели `gpt-image-1`, применяет ретраи и возвращает бинарные данные изображения, и `ImagePipeline`, сочетающий генератор с Google Drive для получения финальной ссылки.
- `app/services/openai_assistants.py` отвечает за обращение к OpenAI Assistants: создаёт треды, отслеживает завершение прогонов, извлекает текстовые ответы и содержит утилиты для обработки решений модератора и формирования запросов на переработку текста.

Все перечисленные сервисы экспортируются через `app/services/__init__.py`, что облегчает их использование в других частях приложения.

## Оркестратор
`app/orchestrator/runner.py` управляет циклом обработки: инициализирует клиентов (Assistants, Google Sheets, Google Drive) и обрабатывает до `per_run_rows` строк, распределяя их по вкладкам. Каждая строка передаётся в `app/orchestrator/processor.py`, который организует полный цикл "писатель → модератор", контролирует лимит итераций, обращается к художественному брифу, генерирует изображение и обновляет все связанные столбцы таблицы.

## Docker-окружение
Сборка и запуск приложения происходит через Docker (образ `python:3.12-slim`). Зависимости устанавливаются во время билда из `requirements.txt`, после чего в контейнер копируется пакет `app`. Запуск выполняется командой `python -m app.main`.
